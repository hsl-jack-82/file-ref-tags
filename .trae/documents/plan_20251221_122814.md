# File Ref Tags 插件功能开发计划（更新版）

## 需求分析

### 核心功能
1. **右键菜单注册**：注册一个名为"FileRefTags"的右键菜单，包含三个二级菜单
2. **添加当前文件到面板**：直接用路径跳转
3. **添加当前文件+选中片段到面板**：存储代码片段，跳转时基于片段搜索
4. **添加当前选中的全局唯一片段到面板**：先判断代码是否全局唯一，若是则跳转，否则提示
5. **面板项显示**：显示类型标识和标题
6. **拖拽调整顺序**：允许面板项之间自由拖拽
7. **持久化存储**：使用JSON文件存储到系统文件夹
8. **支持非代码标签**：允许添加自定义注释项，无跳转功能

## 开发计划

### 阶段一：注册右键菜单和命令
1. 在`package.json`中添加命令定义
2. 添加右键菜单配置
3. 实现命令注册
4. 测试右键菜单是否正常显示

### 阶段二：实现命令功能
1. **添加当前文件到面板**
   - 获取当前文件路径和标题
   - 创建类型1的引用项（文件类型）
   - 添加到面板数据
   - 刷新面板显示

2. **添加当前文件+选中片段到面板**
   - 获取当前文件路径和选中的代码片段
   - 存储代码片段内容，不存储位置
   - 创建类型2的引用项（文件+片段类型）
   - 添加到面板数据
   - 刷新面板显示

3. **添加当前选中的全局唯一片段到面板**
   - 获取选中的代码片段
   - 使用VSCode搜索API进行全局搜索
   - 若唯一，创建类型3的引用项（全局唯一片段类型）
   - 若不唯一，弹窗提示
   - 添加到面板数据
   - 刷新面板显示

### 阶段三：实现面板UI和交互
1. 更新Webview HTML，实现面板项的显示
2. 添加类型标识显示（类型1/2/3和自定义注释）
3. 实现不同类型的标题生成
   - 类型1：文件标题
   - 类型2：文件+代码片段截取
   - 类型3：代码片段截取
   - 自定义注释：用户输入的文字
4. 实现拖拽功能（HTML5拖拽API）
5. 实现点击跳转功能
   - 类型1：直接跳转到文件
   - 类型2：在文件中搜索代码片段并定位
   - 类型3：全局搜索代码片段并定位
   - 自定义注释：无跳转

### 阶段四：实现持久化存储
1. 设计JSON数据结构
2. 实现数据的保存（JSON文件格式）
3. 实现数据的读取
4. 测试数据的持久化效果

### 阶段五：支持非代码标签
1. 添加添加注释项的功能
2. 更新面板UI以支持注释项显示
3. 实现注释项的编辑和删除功能

## 具体实现步骤

### 1. 更新package.json配置
- 添加命令定义（4个命令：添加文件、添加文件+片段、添加全局片段、添加注释）
- 添加右键菜单配置
- 确保所有命令都正确注册

### 2. 实现命令处理
- 创建引用项数据结构
  ```typescript
  interface ReferenceItem {
    id: string;
    type: 'file' | 'file-snippet' | 'global-snippet' | 'comment';
    title: string;
    filePath?: string;
    snippet?: string;
    comment?: string;
    createdAt: Date;
    updatedAt: Date;
  }
  ```
- 实现文件引用添加功能
- 实现代码片段引用添加功能
- 实现全局唯一代码片段判断和添加功能

### 3. 实现数据管理
- 创建数据管理类
- 实现数据的CRUD操作
- 实现拖拽排序功能
- 实现数据的导入导出功能

### 4. 实现Webview通信
- 更新Webview HTML和CSS
- 实现面板项的渲染
- 实现点击事件处理
- 实现拖拽事件处理
- 实现数据同步

### 5. 实现持久化存储
- 使用VSCode的`ExtensionContext`获取存储路径
- 实现数据的JSON序列化和反序列化
- 实现数据的保存和读取功能

### 6. 实现跳转逻辑
- 类型1：使用`vscode.window.showTextDocument`直接跳转到文件
- 类型2：在指定文件中搜索代码片段并定位
- 类型3：全局搜索代码片段并定位

### 7. 测试和优化
- 测试每个功能是否正常工作
- 优化用户体验
- 修复可能的bug

现在我将开始按照这个计划实现插件的功能。